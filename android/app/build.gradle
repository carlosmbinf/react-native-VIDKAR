apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"
apply plugin: 'com.google.android.gms.strict-version-matcher-plugin'

import java.security.KeyStore
import java.security.MessageDigest
import java.io.FileInputStream

/**
 * This is the configuration block to customize your React Native Android app.
 * By default you don't need to apply any configuration, just uncomment the lines you need.
 */
react {
    /* Folders */
    //   The root of your project, i.e. where "package.json" lives. Default is '../..'
    // root = file("../../")
    //   The folder where the react-native NPM package is. Default is ../../node_modules/react-native
    // reactNativeDir = file("../../node_modules/react-native")
    //   The folder where the react-native Codegen package is. Default is ../../node_modules/@react-native/codegen
    // codegenDir = file("../../node_modules/@react-native/codegen")
    //   The cli.js file which is the React Native CLI entrypoint. Default is ../../node_modules/react-native/cli.js
    // cliFile = file("../../node_modules/react-native/cli.js")

    /* Variants */
    //   The list of variants to that are debuggable. For those we're going to
    //   skip the bundling of the JS bundle and the assets. By default is just 'debug'.
    //   If you add flavors like lite, prod, etc. you'll have to list your debuggableVariants.
    // debuggableVariants = ["liteDebug", "prodDebug"]

    /* Bundling */
    //   A list containing the node command and its flags. Default is just 'node'.
    // nodeExecutableAndArgs = ["node"]
    //
    //   The command to run when bundling. By default is 'bundle'
    // bundleCommand = "ram-bundle"
    //
    //   The path to the CLI configuration file. Default is empty.
    // bundleConfig = file(../rn-cli.config.js)
    //
    //   The name of the generated asset file containing your JS bundle
    // bundleAssetName = "MyApplication.android.bundle"
    //
    //   The entry file for bundle generation. Default is 'index.android.js' or 'index.js'
    // entryFile = file("../js/MyApplication.android.js")
    //
    //   A list of extra flags to pass to the 'bundle' commands.
    //   See https://github.com/react-native-community/cli/blob/main/docs/commands.md#bundle
    // extraPackagerArgs = []

    /* Hermes Commands */
    //   The hermes compiler command to run. By default it is 'hermesc'
    // hermesCommand = "$rootDir/my-custom-hermesc/bin/hermesc"
    //
    //   The list of flags to pass to the Hermes compiler. By default is "-O", "-output-source-map"
    // hermesFlags = ["-O", "-output-source-map"]

    /* Autolinking */
    autolinkLibrariesWithApp()
}

/**
 * Set this to true to Run Proguard on Release builds to minify the Java bytecode.
 */
def enableProguardInReleaseBuilds = false

/**
 * The preferred build flavor of JavaScriptCore (JSC)
 *
 * For example, to use the international variant, you can use:
 * `def jscFlavor = 'org.webkit:android-jsc-intl:+'`
 *
 * The international variant includes ICU i18n library and necessary data
 * allowing to use e.g. `Date.toLocaleString` and `String.localeCompare` that
 * give correct results when using with locales other than en-US. Note that
 * this variant is about 6MiB larger per architecture than default.
 */
def jscFlavor = 'org.webkit:android-jsc:+'
def keystorePath = System.getenv("KEYSTORE_PATH") ?: "my-release-key.jks"

println "=== [DEBUG] Variables de entorno de firma ==="
println "KEYSTORE_PATH: ${keystorePath}"
println "KEY_ALIAS: ${System.getenv('KEY_ALIAS')}"
println "KEYSTORE_PASSWORD: ${System.getenv('KEYSTORE_PASSWORD') ? '***' : '(vac√≠o)'}"
println "KEY_PASSWORD: ${System.getenv('KEY_PASSWORD') ? '***' : '(vac√≠o)'}"

println "=== [DEBUG] Contenido del directorio android/ ==="
file("android").listFiles()?.each { f ->
    println (f.isDirectory() ? "[DIR] " : "[FILE] ") + f.name
}

def ksFile = file(keystorePath)
if (ksFile.exists()) {
    if (System.getenv()["CI"]) { // CI=true is exported by Codemagic
        println "‚úÖ Usando keystore de Codemagic"
        ksFile = file(System.getenv()["CM_KEYSTORE_PATH"])
        println System.getenv()["CM_KEYSTORE_PATH"]
        println System.getenv()["CM_KEYSTORE_PASSWORD"]
        println System.getenv()["CM_KEY_ALIAS"]
        println System.getenv()["CM_KEY_PASSWORD"]
    } else {
        println "‚úÖ Usando keystore local: ${ksFile.absolutePath}"
    }
    println "Tama√±o del keystore: ${ksFile.length()} bytes"

    // === SHA1 del keystore ===
    def keystorePassword = (System.getenv("KEYSTORE_PASSWORD") ?: 'lastunas123').toCharArray()
    def keyAliasEnv = System.getenv("KEY_ALIAS")


            


    def printKeystoreSHA1 = { File file, char[] pwd, String aliasOverride ->
        try {
            KeyStore ks = null
            for (def t : ["JKS", "PKCS12"]) {
                try {
                    ks = KeyStore.getInstance(t)
                    ks.load(new FileInputStream(file), pwd)
                    println "Formato de keystore detectado: ${t}"
                    break
                } catch (Exception ignore) {
                    ks = null
                }
            }
            if (ks == null) {
                println "‚ùå No se pudo abrir el keystore (tipo desconocido o password incorrecto)"
                return
            }
            def aliasesEnum = ks.aliases()
            def aliases = []
            while (aliasesEnum.hasMoreElements()) { aliases << aliasesEnum.nextElement() }
            println "Aliases disponibles: ${aliases}"
            if (aliases.isEmpty()) { println "‚ö†Ô∏è Keystore sin aliases"; return }

            def alias = aliasOverride ?: aliases[0]
            if (!ks.containsAlias(alias)) {
                println "‚ö†Ô∏è Alias '${alias}' no encontrado, usando '${aliases[0]}'"
                alias = aliases[0]
            }

            def cert = ks.getCertificate(alias)
            if (cert == null) { println "‚ö†Ô∏è Certificado no encontrado para alias '${alias}'"; return }

            def sha1Bytes = MessageDigest.getInstance("SHA-1").digest(cert.getEncoded())
            def sha1 = sha1Bytes.collect { String.format("%02X", it) }.join(":")
            println "üîë SHA1 (${alias}): ${sha1}"
        } catch (Exception e) {
            println "‚ùå Error obteniendo SHA1: ${e.class.simpleName}: ${e.message}"
        }
    }

    printKeystoreSHA1(ksFile, keystorePassword, keyAliasEnv)
} else {
    println "‚ùå No se encontr√≥ el keystore en: ${ksFile.absolutePath}"
}

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "com.vidkar"
    defaultConfig {
        applicationId "com.vidkar"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion

        def baseVersionCode = 537
        def buildNumber = System.getenv("PROJECT_BUILD_NUMBER")?.toInteger() ?: 0
        println System.getenv("PROJECT_BUILD_NUMBER")

        versionCode baseVersionCode + buildNumber
        versionName "3.0.${baseVersionCode + buildNumber}"
                // Otros valores predeterminados de configuraci√≥n
        resValue "bool", "useExoplayerIMA", "true"
        resValue "bool", "useExoplayerSmoothStreaming", "true"
        resValue "bool", "useExoplayerDash", "true"
        resValue "bool", "useExoplayerHls", "true"
        resValue "bool", "useExoplayerRtsp", "true"
        resValue "bool", "buildFromSource", "true"

        missingDimensionStrategy 'react-native-camera', 'mlkit'
    }
    signingConfigs {
        debug {
            if (System.getenv()["CI"]) { // CI=true is exported by Codemagic
                storeFile file(System.getenv()["CM_KEYSTORE_PATH"])
                storePassword System.getenv()["CM_KEYSTORE_PASSWORD"]
                keyAlias System.getenv()["CM_KEY_ALIAS"]
                keyPassword System.getenv()["CM_KEY_PASSWORD"]
            } else {
                storeFile ksFile
                storePassword System.getenv("KEYSTORE_PASSWORD") ?: "lastunas123"
                keyAlias System.getenv("KEY_ALIAS") ?: "vidkar"
                keyPassword System.getenv("KEY_PASSWORD") ?: "lastunas123"
            }   
        }
        release {
             if (System.getenv()["CI"]) { // CI=true is exported by Codemagic
                storeFile file(System.getenv()["CM_KEYSTORE_PATH"])
                storePassword System.getenv()["CM_KEYSTORE_PASSWORD"]
                keyAlias System.getenv()["CM_KEY_ALIAS"]
                keyPassword System.getenv()["CM_KEY_PASSWORD"]
            } else {
                storeFile ksFile
                storePassword System.getenv("KEYSTORE_PASSWORD") ?: "lastunas123"
                keyAlias System.getenv("KEY_ALIAS") ?: "vidkar"
                keyPassword System.getenv("KEY_PASSWORD") ?: "lastunas123"
            }            
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            // Caution! In production, you need to generate your own keystore file.
            // see https://reactnative.dev/docs/signed-apk-android.
            signingConfig signingConfigs.release
            minifyEnabled enableProguardInReleaseBuilds
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

dependencies {
    // The version of react-native is set by the React Native Gradle Plugin
    implementation("com.facebook.react:react-android")

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation jscFlavor
    }
    // If your app supports Android versions before Ice Cream Sandwich (API level 14)
    implementation 'com.facebook.fresco:animated-base-support:1.3.0'

    // For animated GIF support
    implementation 'com.facebook.fresco:animated-gif:3.6.0'

    // For WebP support, including animated WebP
    implementation 'com.facebook.fresco:animated-webp:3.6.0'
    implementation 'com.facebook.fresco:webpsupport:3.6.0'

    // For WebP support, without animations
    implementation 'com.facebook.fresco:webpsupport:3.6.0'

    debugImplementation 'com.facebook.flipper:flipper:0.125.0'
    debugImplementation 'com.facebook.flipper:flipper-network-plugin:0.125.0'
    debugImplementation 'com.facebook.flipper:flipper-fresco-plugin:0.125.0'

    
}

apply from: "../../node_modules/react-native-vector-icons/fonts.gradle"
// apply plugin: 'com.google.gms.google-services'  // Google Services plugin
// apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
apply plugin: 'com.google.gms.google-services' // <- Add this line